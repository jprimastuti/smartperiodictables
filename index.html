<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Periodic Table Explorer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic touch -->
    <script type="module" src="https://unpkg.com/lucide@latest"></script>
    <!-- Load three.js for 3D visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Custom styles for the table grid */
        .periodic-table-grid {
            display: grid;
            grid-template-columns: repeat(18, minmax(0, 1fr));
            gap: 4px; /* Reduced gap for a tighter look */
            max-width: 1400px;
            margin: auto;
        }

        /* Styling for each element block */
        .element-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            aspect-ratio: 1 / 1.1; /* Slightly taller than wide */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            position: relative;
            user-select: none;
        }
        
        /* Hover effect to make it interactive */
        .element-block:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10; /* Bring forward on hover */
        }
        
        /* Typography */
        .atomic-number {
            font-size: 0.7rem; /* Smaller for number */
            font-weight: 500;
            line-height: 1;
            position: absolute;
            top: 2px;
            left: 4px;
        }

        .symbol {
            font-size: 1.4rem; /* Prominent symbol */
            font-weight: 800;
            line-height: 1;
            margin-top: -2px; /* Adjust vertical alignment */
        }

        .atomic-mass {
            font-size: 0.6rem; /* Smallest for mass */
            font-weight: 400;
            line-height: 1;
            position: absolute;
            bottom: 2px;
            right: 4px;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .periodic-table-grid {
                gap: 2px;
            }
            .symbol {
                font-size: 1rem;
            }
            .atomic-number {
                font-size: 0.6rem;
            }
            .atomic-mass {
                display: none; /* Hide mass on small screens to save space */
            }
            /* Adjust detail card for mobile */
            #detail-card {
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
                box-shadow: none;
                overflow-y: auto;
            }
            #bohr-model-container {
                height: 200px !important; /* Smaller canvas on mobile */
            }
        }

        /* Element Type Coloring (for utility classes) */
        .color-alkali { background-color: #ff9999; color: #400000; } /* Light Red/Orange */
        .color-alkaline { background-color: #ffc966; color: #4d2600; } /* Light Orange/Yellow */
        .color-transition { background-color: #99ccff; color: #002d4d; } /* Light Blue */
        .color-post-transition { background-color: #99ffcc; color: #004d33; } /* Light Teal */
        .color-metalloid { background-color: #e699ff; color: #3d004d; } /* Light Violet */
        .color-nonmetal { background-color: #99ff99; color: #004d00; } /* Light Green */
        .color-noble { background-color: #ccccff; color: #1a1a4d; } /* Lavender */
        .color-lanthanide { background-color: #ffb3ff; color: #4d004d; } /* Pink */
        .color-actinide { background-color: #ff66ff; color: #660066; } /* Brighter Pink */
        .color-unknown { background-color: #f0f0f0; color: #666666; } /* Gray */
        
        .correct-answer {
            background-color: #d1fae5; /* Tailwind green-100 */
            border-color: #34d399; /* Tailwind green-400 */
        }
        
    </style>
</head>
<body class="bg-gray-50 p-4 min-h-screen">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-2 mt-4">
            Smart Periodic Table Explorer
        </h1>
        <p class="text-center text-sm sm:text-base text-gray-600 mb-6">
            Click on any element to reveal its secrets!
        </p>

        <!-- Periodic Table Grid Container -->
        <div id="periodic-table" class="periodic-table-grid">
            <!-- Elements will be inserted here by JavaScript -->
        </div>

        <!-- Detail Information Card (Initially Hidden) -->
        <div id="detail-card" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
            <div id="card-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 relative" role="dialog" aria-modal="true">
                
                <!-- Close Button -->
                <button onclick="hideDetailCard()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 p-2 rounded-full transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                
                <div class="flex items-start mb-4">
                    <!-- Element Symbol/Number/Name -->
                    <div id="detail-symbol-block" class="flex-shrink-0 mr-4 p-4 rounded-lg text-white text-center shadow-lg w-20 h-20 flex flex-col justify-center items-center">
                        <span id="detail-number" class="text-xs font-semibold absolute top-1 left-2"></span>
                        <span id="detail-symbol" class="text-4xl font-bold"></span>
                        <span id="detail-mass" class="text-xs font-medium absolute bottom-1 right-2"></span>
                    </div>
                    <div class="flex-grow">
                        <h2 id="detail-name" class="text-3xl font-extrabold text-gray-900 mb-1"></h2>
                        <span id="detail-type" class="text-sm font-medium px-3 py-1 rounded-full text-white"></span>
                    </div>
                </div>

                <!-- Core Data -->
                <div class="grid grid-cols-2 gap-4 border-t pt-4 mt-4">
                    <div>
                        <p class="text-sm font-semibold text-gray-500">Atomic Number (Z)</p>
                        <p id="data-number" class="text-xl font-bold text-blue-600"></p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-500">Atomic Mass (g/mol)</p>
                        <p id="data-mass" class="text-xl font-bold text-green-600"></p>
                    </div>
                </div>
                
                <!-- 3D Visualization Section -->
                <div class="mt-6">
                    <h3 class="flex items-center text-lg font-bold text-gray-800 mb-2">
                        <span class="mr-2">‚öõÔ∏è</span> Bohr Model Visualization
                    </h3>
                    <div id="bohr-model-container" class="w-full bg-gray-100 rounded-lg shadow-inner flex justify-center items-center" style="height: 300px; cursor: grab;">
                        <!-- Canvas will be appended here -->
                    </div>
                    <div id="nucleus-info" class="text-xs text-center mt-2 text-gray-600"></div>
                </div>


                <!-- Electronic Configuration -->
                <div class="mt-4">
                    <p class="text-sm font-semibold text-gray-500 mb-1">Sub-level Electronic Configuration</p>
                    <p id="data-config" class="text-lg font-mono p-2 bg-gray-100 rounded-lg overflow-x-auto text-purple-700"></p>
                </div>

                <!-- Fun Fact -->
                <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg">
                    <h3 class="flex items-center text-lg font-bold text-yellow-800 mb-2">
                        <span class="mr-2">üí°</span> Fun Fact!
                    </h3>
                    <p id="data-fact" class="text-gray-700 italic text-base"></p>
                </div>
                
                <!-- LLM-Powered Features Section -->
                <div class="mt-6 border-t pt-6">
                    <h3 class="flex items-center text-lg font-bold text-gray-800 mb-3">
                        <span class="mr-2 text-xl">üöÄ</span> AI Exploration Tools
                    </h3>
                    
                    <div class="space-y-4">
                        <!-- Analogy Button and Output -->
                        <button id="analogy-button" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition disabled:opacity-50">
                            ‚ú® Generate Analogy
                        </button>
                        <div id="analogy-output" class="hidden p-3 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg text-sm text-gray-800"></div>

                        <!-- Quiz Button and Output -->
                        <button id="quiz-button" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition disabled:opacity-50">
                            ‚ú® Generate Quiz Question
                        </button>
                        <div id="quiz-output" class="hidden p-3 bg-purple-50 border-l-4 border-purple-400 rounded-lg text-sm text-gray-800"></div>
                    </div>
                </div>

                <!-- Global Loading Indicator (inside the card for context) -->
                <div id="loading-indicator" class="hidden absolute inset-0 flex items-center justify-center bg-white/90 z-10 rounded-xl">
                    <div class="flex items-center space-x-2 text-indigo-600 font-semibold">
                        <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Generating AI content...</span>
                    </div>
                </div>
                
            </div>
        </div>

    </div>

    <script>
        // --- Gemini API Configuration ---
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- 3D Visualization Variables ---
        let scene, camera, renderer, atomGroup;
        let animationFrameId; // To control the animation loop
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        const ROTATION_SPEED = 0.005;

        // Helper function for exponential backoff (retry)
        async function fetchRetry(url, options, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // 429 is Too Many Requests
                        return response;
                    }
                    // Only log retry attempt, not error
                } catch (error) {
                    // Only log retry attempt, not error
                }
                await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
            }
            throw new Error('API request failed after multiple retries.');
        }

        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        // --- Gemini Feature 1: Analogy Generation (Standard Text) ---
        async function generateAnalogy(elementName) {
            // ... (Same as before)
            const analogyOutput = document.getElementById('analogy-output');
            analogyOutput.classList.add('hidden');
            analogyOutput.innerHTML = '';
            
            showLoading(true);

            const userQuery = `Create a concise, high school-level analogy to explain the key chemical properties and behavior of the element ${elementName}. Keep the analogy engaging and descriptive.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: "Act as a creative chemistry teacher focused on making complex concepts relatable through metaphor and analogy. Provide only the analogy text." }]
                },
            };

            try {
                const response = await fetchRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    analogyOutput.innerHTML = `<span class="font-bold block mb-1">Analogy for ${elementName}:</span>${text}`;
                    analogyOutput.classList.remove('hidden');
                } else {
                    analogyOutput.innerHTML = 'Sorry, I couldn\'t generate an analogy right now. Try again later.';
                    analogyOutput.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Gemini Analogy API Error:", error);
                analogyOutput.innerHTML = 'An error occurred while connecting to the AI tool.';
                analogyOutput.classList.remove('hidden');
            } finally {
                showLoading(false);
            }
        }

        // --- Gemini Feature 2: Quiz Question Generation (Structured JSON) ---
        async function generateQuizQuestion(elementName) {
            // ... (Same as before)
            const quizOutput = document.getElementById('quiz-output');
            quizOutput.classList.add('hidden');
            quizOutput.innerHTML = '';
            
            showLoading(true);

            const userQuery = `Generate a single multiple-choice quiz question about the element ${elementName}, specifically focusing on its periodic table classification, atomic structure, or main uses. The question must have exactly 4 options and one correct answer.`;

            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    "question": { "type": "STRING", "description": "The multiple-choice question text." },
                    "options": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "Exactly four answer options." },
                    "correctAnswerIndex": { "type": "NUMBER", "description": "0-based index (0, 1, 2, or 3) of the correct answer in the options array." },
                    "explanation": { "type": "STRING", "description": "A brief explanation of why the correct answer is right." }
                },
                required: ["question", "options", "correctAnswerIndex", "explanation"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                },
                systemInstruction: {
                    parts: [{ text: "You are a quiz master for high school chemistry. Generate a single question object that strictly adheres to the provided JSON schema." }]
                }
            };

            try {
                const response = await fetchRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const quizData = JSON.parse(jsonText);
                    renderQuiz(quizData, quizOutput);
                } else {
                    quizOutput.innerHTML = 'Sorry, I couldn\'t generate a structured quiz question. Try again later.';
                    quizOutput.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Gemini Quiz API Error:", error);
                quizOutput.innerHTML = 'An error occurred while connecting to the AI tool or parsing the response.';
                quizOutput.classList.remove('hidden');
            } finally {
                showLoading(false);
            }
        }

        // Function to render the generated quiz and handle interaction
        function renderQuiz(quiz, container) {
            // ... (Same as before)
            let html = `
                <div class="font-bold text-gray-900 mb-2">${quiz.question}</div>
                <div class="space-y-2">
            `;

            quiz.options.forEach((option, index) => {
                html += `
                    <button 
                        class="quiz-option w-full text-left p-3 border border-purple-300 rounded-md hover:bg-purple-100 transition text-gray-700"
                        data-index="${index}"
                    >
                        ${String.fromCharCode(65 + index)}. ${option}
                    </button>
                `;
            });
            
            html += `</div><div id="quiz-explanation" class="mt-4 hidden p-3 text-sm rounded-lg border"></div>`;
            container.innerHTML = html;
            container.classList.remove('hidden');

            const options = container.querySelectorAll('.quiz-option');
            let answered = false;

            options.forEach(button => {
                button.addEventListener('click', () => {
                    if (answered) return;
                    answered = true;
                    
                    const selectedIndex = parseInt(button.getAttribute('data-index'));
                    const explanationDiv = document.getElementById('quiz-explanation');
                    explanationDiv.classList.remove('hidden');
                    explanationDiv.innerHTML = `<span class="font-bold block mb-1">Explanation:</span> ${quiz.explanation}`;

                    if (selectedIndex === quiz.correctAnswerIndex) {
                        button.classList.add('correct-answer', 'border-green-500', 'bg-green-100', 'font-bold');
                        explanationDiv.classList.add('bg-green-50', 'border-green-500', 'text-green-800');
                    } else {
                        button.classList.add('bg-red-100', 'border-red-500');
                        explanationDiv.classList.add('bg-red-50', 'border-red-500', 'text-red-800');
                        // Highlight correct answer
                        options[quiz.correctAnswerIndex].classList.add('correct-answer', 'border-green-500', 'bg-green-100');
                    }
                    
                    // Disable all buttons after answering
                    options.forEach(btn => btn.disabled = true);
                });
            });
        }
        
        // --- 3D Visualization Logic (three.js) ---
        
        function renderBohrModel(data) {
            const container = document.getElementById('bohr-model-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 1. Cleanup previous model
            if (renderer) {
                cancelAnimationFrame(animationFrameId);
                renderer.dispose();
            }
            container.innerHTML = '';
            
            // 2. Scene Setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);
            
            atomGroup = new THREE.Group();
            scene.add(atomGroup);

            // 3. Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1.2);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            // 4. Constants
            const nucleusRadius = 0.5;
            const electronRadius = 0.1;
            const orbitRadii = [1.5, 2.5, 3.5, 4.5, 5.5]; // Radii for K, L, M, N, O shells

            // 5. Nucleus (Protons and Neutrons)
            const protons = data.number;
            const neutrons = Math.round(data.mass) - protons;
            
            document.getElementById('nucleus-info').innerHTML = `
                <span class="font-bold text-red-600">${protons} Protons</span> + 
                <span class="font-bold text-blue-600">${neutrons} Neutrons</span> 
                in the Nucleus
            `;

            // Draw a single central sphere for the nucleus
            const nucleusGeometry = new THREE.SphereGeometry(nucleusRadius, 32, 32);
            const nucleusMaterial = new THREE.MeshPhongMaterial({ color: 0x999999 }); // Gray/mixed
            const nucleus = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            atomGroup.add(nucleus);


            // 6. Electron Orbits and Electrons
            
            // This group will hold all electrons to animate them independently
            const electronGroups = []; 

            data.shells.forEach((electronsInShell, shellIndex) => {
                if (electronsInShell === 0) return;
                
                const orbitRadius = orbitRadii[shellIndex];
                if (!orbitRadius) return; // Safety check

                // A. Draw Orbit Ring
                const orbitGeometry = new THREE.TorusGeometry(orbitRadius, 0.01, 16, 100);
                const orbitMaterial = new THREE.MeshBasicMaterial({ color: 0xcccccc });
                const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                // Tilt orbits for better 3D look
                orbit.rotation.x = Math.PI / 2; 
                orbit.rotation.y = shellIndex * 0.1; // Small offset tilt
                atomGroup.add(orbit);
                
                // B. Place Electrons
                const electronGroup = new THREE.Group(); // Group for the current shell's electrons
                
                for (let i = 0; i < electronsInShell; i++) {
                    const electronGeometry = new THREE.SphereGeometry(electronRadius, 16, 16);
                    const electronMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00 }); // Green for electrons
                    const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                    
                    // Position electron on the orbit ring initially
                    const angle = (i / electronsInShell) * Math.PI * 2;
                    electron.position.set(Math.cos(angle) * orbitRadius, 0, Math.sin(angle) * orbitRadius);
                    
                    electronGroup.add(electron);
                }
                
                // Apply the same tilt to the electron group so they move on the orbit plane
                electronGroup.rotation.x = orbit.rotation.x;
                electronGroup.rotation.y = orbit.rotation.y;
                atomGroup.add(electronGroup);
                electronGroups.push(electronGroup);
            });
            
            // 7. Camera Positioning
            camera.position.z = orbitRadii[data.shells.length - 1] + 2 || 5; 
            
            // 8. Interaction (Mouse Drag Rotation)
            const rotationContainer = container.querySelector('canvas') || container;

            rotationContainer.addEventListener('mousedown', onMouseDown, false);
            rotationContainer.addEventListener('mousemove', onMouseMove, false);
            rotationContainer.addEventListener('mouseup', onMouseUp, false);
            rotationContainer.addEventListener('mouseleave', onMouseUp, false); 
            
            // Touch support for mobile
            rotationContainer.addEventListener('touchstart', onTouchStart, false);
            rotationContainer.addEventListener('touchmove', onTouchMove, false);
            rotationContainer.addEventListener('touchend', onMouseUp, false);

            function onMouseDown(event) {
                isDragging = true;
                previousMousePosition.x = event.clientX;
                previousMousePosition.y = event.clientY;
                rotationContainer.style.cursor = 'grabbing';
            }
            function onTouchStart(event) {
                event.preventDefault(); // Prevent scrolling
                isDragging = true;
                const touch = event.touches[0];
                previousMousePosition.x = touch.clientX;
                previousMousePosition.y = touch.clientY;
                rotationContainer.style.cursor = 'grabbing';
            }

            function onMouseMove(event) {
                if (!isDragging) return;
                
                const deltaX = event.clientX - previousMousePosition.x;
                const deltaY = event.clientY - previousMousePosition.y;

                atomGroup.rotation.y += deltaX * ROTATION_SPEED;
                atomGroup.rotation.x += deltaY * ROTATION_SPEED;
                
                previousMousePosition.x = event.clientX;
                previousMousePosition.y = event.clientY;
            }
            function onTouchMove(event) {
                if (!isDragging) return;
                event.preventDefault(); // Prevent scrolling

                const touch = event.touches[0];
                const deltaX = touch.clientX - previousMousePosition.x;
                const deltaY = touch.clientY - previousMousePosition.y;

                atomGroup.rotation.y += deltaX * ROTATION_SPEED * 1.5; // Faster touch rotation
                atomGroup.rotation.x += deltaY * ROTATION_SPEED * 1.5;
                
                previousMousePosition.x = touch.clientX;
                previousMousePosition.y = touch.clientY;
            }

            function onMouseUp() {
                isDragging = false;
                rotationContainer.style.cursor = 'grab';
            }
            
            // 9. Animation Loop
            let time = 0;
            const electronSpeed = 0.005; // Base speed
            
            function animate() {
                animationFrameId = requestAnimationFrame(animate);

                // Animate electrons around the nucleus
                electronGroups.forEach((group, index) => {
                    // Different rotation speed for each shell
                    group.rotation.z += electronSpeed / (index + 1); 
                });

                // Continuous slow rotation if not dragging (to show 3D nature)
                if (!isDragging) {
                    atomGroup.rotation.y += 0.001; 
                }

                renderer.render(scene, camera);
                time++;
            }
            
            // Handle resizing
            function onWindowResize() {
                const container = document.getElementById('bohr-model-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }

            window.addEventListener('resize', onWindowResize, false);
            
            animate();
            
        }

        // --- Element Data with Shells Added ---
        const periodicTableData = {
            'H': { pos: [1, 1], name: 'Hydrogen', number: 1, mass: 1.008, config: '1s¬π', shells: [1], type: 'nonmetal', fact: 'The most abundant element in the universe, constituting roughly 75% of all baryonic mass.' },
            'He': { pos: [1, 18], name: 'Helium', number: 2, mass: 4.0026, config: '1s¬≤', shells: [2], type: 'noble', fact: 'Its boiling point is the lowest among all elements, making it essential for cryogenic research.' },
            
            'Li': { pos: [2, 1], name: 'Lithium', number: 3, mass: 6.94, config: '[He] 2s¬π', shells: [2, 1], type: 'alkali', fact: 'Used in batteries for phones and cars, it is the lightest metal.' },
            'Be': { pos: [2, 2], name: 'Beryllium', number: 4, mass: 9.0122, config: '[He] 2s¬≤', shells: [2, 2], type: 'alkaline', fact: 'Its lightness and high melting point make it perfect for aerospace parts.' },
            'B': { pos: [2, 13], name: 'Boron', number: 5, mass: 10.81, config: '[He] 2s¬≤ 2p¬π', shells: [2, 3], type: 'metalloid', fact: 'Found in the mineral borax, it is often used in pyrotechnics for a green color.' },
            'C': { pos: [2, 14], name: 'Carbon', number: 6, mass: 12.011, config: '[He] 2s¬≤ 2p¬≤', shells: [2, 4], type: 'nonmetal', fact: 'The basis of all known life, forming diamonds, graphite, and living tissue.' },
            'N': { pos: [2, 15], name: 'Nitrogen', number: 7, mass: 14.007, config: '[He] 2s¬≤ 2p¬≥', shells: [2, 5], type: 'nonmetal', fact: 'Makes up about 78% of Earth\'s atmosphere, mostly in the form of N‚ÇÇ gas.' },
            'O': { pos: [2, 16], name: 'Oxygen', number: 8, mass: 15.999, config: '[He] 2s¬≤ 2p‚Å¥', shells: [2, 6], type: 'nonmetal', fact: 'Essential for respiration and combustion, it is the third most abundant element in the universe.' },
            'F': { pos: [2, 17], name: 'Fluorine', number: 9, mass: 18.998, config: '[He] 2s¬≤ 2p‚Åµ', shells: [2, 7], type: 'nonmetal', fact: 'The most chemically reactive and electronegative element.' },
            'Ne': { pos: [2, 18], name: 'Neon', number: 10, mass: 20.180, config: '[He] 2s¬≤ 2p‚Å∂', shells: [2, 8], type: 'noble', fact: 'Gives the characteristic bright orange-red glow to "neon" signs.' },

            'Na': { pos: [3, 1], name: 'Sodium', number: 11, mass: 22.990, config: '[Ne] 3s¬π', shells: [2, 8, 1], type: 'alkali', fact: 'Highly reactive metal; its salt (NaCl) is essential for human life.' },
            'Mg': { pos: [3, 2], name: 'Magnesium', number: 12, mass: 24.305, config: '[Ne] 3s¬≤', shells: [2, 8, 2], type: 'alkaline', fact: 'Used in lightweight alloys and is the core element in the chlorophyll molecule.' },
            'Al': { pos: [3, 13], name: 'Aluminum', number: 13, mass: 26.982, config: '[Ne] 3s¬≤ 3p¬π', shells: [2, 8, 3], type: 'post-transition', fact: 'The most abundant metal in Earth\'s crust, valued for its low density and corrosion resistance.' },
            'Si': { pos: [3, 14], name: 'Silicon', number: 14, mass: 28.085, config: '[Ne] 3s¬≤ 3p¬≤', shells: [2, 8, 4], type: 'metalloid', fact: 'The second most abundant element in the Earth\'s crust and the basis of modern electronics.' },
            'P': { pos: [3, 15], name: 'Phosphorus', number: 15, mass: 30.974, config: '[Ne] 3s¬≤ 3p¬≥', shells: [2, 8, 5], type: 'nonmetal', fact: 'Has several allotropes; white phosphorus glows in the dark (chemiluminescence).' },
            'S': { pos: [3, 16], name: 'Sulfur', number: 16, mass: 32.06, config: '[Ne] 3s¬≤ 3p‚Å¥', shells: [2, 8, 6], type: 'nonmetal', fact: 'It smells like rotten eggs when combined with hydrogen (H‚ÇÇS).' },
            'Cl': { pos: [3, 17], name: 'Chlorine', number: 17, mass: 35.45, config: '[Ne] 3s¬≤ 3p‚Åµ', shells: [2, 8, 7], type: 'nonmetal', fact: 'Used as a powerful disinfectant and a component in table salt.' },
            'Ar': { pos: [3, 18], name: 'Argon', number: 18, mass: 39.948, config: '[Ne] 3s¬≤ 3p‚Å∂', shells: [2, 8, 8], type: 'noble', fact: 'Used in light bulbs to protect the filament from oxidizing.' },

            // Placeholders for visual structure
            'Placeholder_Period_4_Start': { pos: [4, 3], symbol: '', type: 'unknown', placeholder: true },
            'Placeholder_Period_5_Start': { pos: [5, 3], symbol: '', type: 'unknown', placeholder: true },
            'Placeholder_Lanthanides': { pos: [6, 3], symbol: '57-71', type: 'lanthanide', label: 'Lanthanides' },
            'Placeholder_Actinides': { pos: [7, 3], symbol: '89-103', type: 'actinide', label: 'Actinides' },
        };
        
        // Define color classes mapped to element types
        const typeColorMap = {
            'alkali': { bg: 'color-alkali', text: 'text-white' },
            'alkaline': { bg: 'color-alkaline', text: 'text-gray-900' },
            'transition': { bg: 'color-transition', text: 'text-gray-900' },
            'post-transition': { bg: 'color-post-transition', text: 'text-gray-900' },
            'metalloid': { bg: 'color-metalloid', text: 'text-gray-900' },
            'nonmetal': { bg: 'color-nonmetal', text: 'text-gray-900' },
            'noble': { bg: 'color-noble', text: 'text-gray-900' },
            'lanthanide': { bg: 'color-lanthanide', text: 'text-gray-900' },
            'actinide': { bg: 'color-actinide', text: 'text-gray-900' },
            'unknown': { bg: 'bg-gray-200', text: 'text-gray-500' },
        };

        const tableContainer = document.getElementById('periodic-table');
        const detailCard = document.getElementById('detail-card');
        const cardContent = document.getElementById('card-content');
        let currentElementSymbol = null; // Store the currently viewed element

        // Function to create and render all elements
        function renderPeriodicTable() {
            // Create a temporary array to hold all 18x7 cells, initialized to null
            const grid = Array(7).fill(null).map(() => Array(18).fill(null));

            // Populate the grid array with element data
            for (const symbol in periodicTableData) {
                const element = periodicTableData[symbol];
                const [row, col] = element.pos;
                // row and col are 1-based, array indices are 0-based
                if (grid[row - 1] && grid[row - 1][col - 1] === null) {
                    grid[row - 1][col - 1] = { symbol, data: element };
                }
            }

            // Manually insert blank spacers and the Lanthanide/Actinide block
            // Period 4, Group 3-12 (10 spaces)
            for (let i = 2; i < 12; i++) {
                grid[3][i] = { symbol: 'Empty', data: { placeholder: true } };
                grid[4][i] = { symbol: 'Empty', data: { placeholder: true } };
            }
            
            // Period 6 (row 5) and 7 (row 6) - Gap for Lanthanides/Actinides
            grid[5][2] = { symbol: 'Gap', data: { placeholder: true, label: '57-71' } };
            grid[6][2] = { symbol: 'Gap', data: { placeholder: true, label: '89-103' } };


            // Render the grid to the DOM
            tableContainer.innerHTML = ''; // Clear previous content

            grid.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    const block = document.createElement('div');
                    block.classList.add('element-block', 'flex-shrink-0');

                    if (cell) {
                        const data = cell.data;
                        const symbol = cell.symbol;
                        const { bg, text } = typeColorMap[data.type || 'unknown'];

                        block.classList.add(bg, text);

                        if (data.placeholder) {
                             // Handle the 10-column gap for Period 4/5
                            if (colIndex >= 2 && colIndex <= 11 && rowIndex > 2 && rowIndex < 5) {
                                block.classList.add('bg-gray-100', 'hover:transform-none', 'hover:shadow-none', 'cursor-default');
                            } else if (data.label) {
                                // Lanthanide/Actinide place holders
                                block.classList.remove(bg);
                                block.classList.add('bg-gray-300', 'text-gray-800', 'col-span-10', 'hover:transform-none', 'hover:shadow-none', 'cursor-default', 'flex', 'justify-center', 'items-center');
                                block.style.gridColumn = `${colIndex + 1} / span 10`;
                                block.innerHTML = `<span class="text-xs font-semibold">${data.label}</span>`;
                            } else {
                                // Default empty cell style
                                block.classList.add('bg-gray-100', 'hover:transform-none', 'hover:shadow-none', 'cursor-default');
                            }
                        } else {
                            // Render a standard element block
                            block.setAttribute('data-symbol', symbol);
                            block.onclick = () => showDetailCard(symbol);

                            block.innerHTML = `
                                <span class="atomic-number">${data.number}</span>
                                <span class="symbol">${symbol}</span>
                                <span class="atomic-mass">${data.mass.toFixed(4)}</span>
                            `;
                        }

                    } else {
                        // Invisible spacer for unpopulated areas (e.g., Period 1, Group 2-17)
                        block.classList.add('bg-transparent', 'shadow-none', 'hover:transform-none', 'hover:shadow-none', 'cursor-default');
                    }

                    // Only append blocks that are not intentional gaps for Lanthanides/Actinides
                    if (!(rowIndex === 5 && colIndex >= 3) && !(rowIndex === 6 && colIndex >= 3)) {
                         tableContainer.appendChild(block);
                    }
                });
                
                // Manually insert the Lanthanide/Actinide block spanning 10 columns
                if (rowIndex === 5) {
                    const block = document.createElement('div');
                    block.classList.add('element-block', 'bg-purple-100', 'text-gray-600', 'col-span-10', 'hover:transform-none', 'hover:shadow-none', 'cursor-default', 'flex', 'justify-center', 'items-center', 'text-xs', 'font-semibold');
                    block.style.gridColumn = '3 / span 10';
                    block.innerHTML = 'Lanthanide Series (57-71)';
                    tableContainer.appendChild(block);
                }
                 if (rowIndex === 6) {
                    const block = document.createElement('div');
                    block.classList.add('element-block', 'bg-pink-100', 'text-gray-600', 'col-span-10', 'hover:transform-none', 'hover:shadow-none', 'cursor-default', 'flex', 'justify-center', 'items-center', 'text-xs', 'font-semibold');
                    block.style.gridColumn = '3 / span 10';
                    block.innerHTML = 'Actinide Series (89-103)';
                    tableContainer.appendChild(block);
                }
            });
            
            // Add a clear break after Period 3 for better visual grouping
             if (grid.length > 3) {
                const breakElement = document.createElement('div');
                breakElement.classList.add('col-span-18', 'h-4', 'bg-transparent');
                tableContainer.appendChild(breakElement);
            }
        }
        
        // Function to update and display the detail card
        function showDetailCard(symbol) {
            const data = periodicTableData[symbol];
            if (!data) return;

            currentElementSymbol = symbol; // Set the current element
            
            // Get color mapping for the detail card symbol block
            const { bg, text } = typeColorMap[data.type];
            
            // 1. Update the Card Content and Styling
            const detailSymbolBlock = document.getElementById('detail-symbol-block');
            detailSymbolBlock.className = ''; // Clear existing classes
            detailSymbolBlock.classList.add('flex-shrink-0', 'mr-4', 'p-4', 'rounded-lg', 'text-center', 'shadow-lg', 'w-20', 'h-20', 'flex', 'flex-col', 'justify-center', 'items-center', 'relative', bg, text);

            // 2. Populate Detail View
            document.getElementById('detail-symbol').textContent = symbol;
            document.getElementById('detail-number').textContent = data.number;
            document.getElementById('detail-mass').textContent = data.mass.toFixed(4);
            document.getElementById('detail-name').textContent = data.name;
            
            // Element Type Badge
            const typeBadge = document.getElementById('detail-type');
            typeBadge.textContent = data.type.toUpperCase().replace('-', ' ');
            
            // Set Badge color dynamically based on type (a bit verbose but works with Tailwind/custom colors)
            typeBadge.className = 'text-sm font-medium px-3 py-1 rounded-full text-white ';
            if (data.type === 'nonmetal') typeBadge.classList.add('bg-green-600');
            else if (data.type === 'noble') typeBadge.classList.add('bg-red-500');
            else if (data.type === 'alkali') typeBadge.classList.add('bg-orange-500');
            else if (data.type === 'alkaline') typeBadge.classList.add('bg-yellow-600');
            else if (data.type === 'metalloid') typeBadge.classList.add('bg-purple-600');
            else if (data.type === 'post-transition') typeBadge.classList.add('bg-teal-500');
            else typeBadge.classList.add('bg-gray-500');


            // 3. Populate Data Fields
            document.getElementById('data-number').textContent = data.number;
            document.getElementById('data-mass').textContent = data.mass.toFixed(4);
            document.getElementById('data-config').textContent = data.config;
            document.getElementById('data-fact').textContent = data.fact;
            
            // 4. Render 3D Model
            renderBohrModel(data);

            // 5. Reset LLM features and attach listeners
            document.getElementById('analogy-output').classList.add('hidden');
            document.getElementById('quiz-output').classList.add('hidden');

            // Remove existing listeners before adding new one to prevent duplicates
            const analogyButton = document.getElementById('analogy-button');
            const quizButton = document.getElementById('quiz-button');
            
            analogyButton.replaceWith(analogyButton.cloneNode(true));
            quizButton.replaceWith(quizButton.cloneNode(true));
            
            document.getElementById('analogy-button').addEventListener('click', () => generateAnalogy(data.name));
            document.getElementById('quiz-button').addEventListener('click', () => generateQuizQuestion(data.name));


            // 6. Show the Card
            detailCard.classList.remove('hidden');
            detailCard.classList.add('flex');
            cardContent.classList.remove('scale-95', 'opacity-0');
            cardContent.classList.add('scale-100', 'opacity-100');
            
            // Trap focus for accessibility
            cardContent.focus();
        }

        // Function to hide the detail card
        function hideDetailCard() {
             // Stop the 3D animation loop
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            cardContent.classList.remove('scale-100', 'opacity-100');
            cardContent.classList.add('scale-95', 'opacity-0');
            
            // Hide the container after the transition
            setTimeout(() => {
                detailCard.classList.remove('flex');
                detailCard.classList.add('hidden');
                currentElementSymbol = null; // Clear current element
            }, 300);
        }

        // Initial setup on load
        window.onload = function() {
            renderPeriodicTable();

            // Handle ESC key to close the modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && detailCard.classList.contains('flex')) {
                    hideDetailCard();
                }
            });
            
            // Handle clicking outside the modal content to close it
            detailCard.addEventListener('click', (e) => {
                if (e.target === detailCard) {
                    hideDetailCard();
                }
            });
        };
    </script>
</body>
</html>
